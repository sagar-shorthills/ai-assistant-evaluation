You are working on a MongoDB Data Exploration Tool with GST Integration, built using:

Backend: Node.js + Express.js (latest stable)

Database: MongoDB (latest)

Frontend: React.js with Material UI (MUI v5+)

Current Codebase
The backend folder has:

/config/db.js → MongoDB connection setup

/controllers/collectionController.js, queryController.js → main controllers

/services/mongoService.js → MongoDB access helpers

/routes/collectionRoutes.js, queryRoutes.js → API routes

/utils/gstCalculator.js → GST-related calculations

Objective
I want you to add a new backend feature:

API Endpoint: POST /api/report/gstr3b

Controller: Add a gstrController.js

Route: Wire this endpoint in the Express routes

Logic: Generate the GSTR-3B monthly GST return report for a company

Detailed Requirements
Data Sources (MongoDB collections):

companies: Company master details

supply_transactions: Outward/inward supply transactions

itc_payments: ITC (Input Tax Credit) and payment details

Input:

companyId (UUID string)

year (number, e.g., 2025)

month (number, 1–12)

Processing Tasks:

Fetch company details → from companies

Aggregate supply transactions → group by:

Type: OUTWARD/INWARD

SubType: TAXABLE, ZERO_RATED, EXEMPT, RCM

Calculate totals for taxable value and taxes (integrated, central, state, cess)

Identify reverse charge (RCM) inward supplies

Get e-commerce operator transactions → filter supply_transactions where counterparty is an e-commerce operator

Break down inter-state supplies → by unregistered persons, composition dealers, UIN holders

Aggregate ITC (Input Tax Credit) → from itc_payments, calculate:

Eligible ITC

Reversed ITC

Net ITC = eligible - reversed

Reclaimed ITC

Ineligible ITC

Calculate payments → tax payable, ITC used, cash paid, interest, late fees

Output Response:
A JSON object structured as:

{
  "company": { "legalName": "...", "tradeName": "...", "gstin": "...", "authorizedSignatory": { "name": "...", "designation": "..." } },
  "period": { "year": 2025, "month": 1 },
  "section3_1": { ... },
  "section3_1_1": { ... },
  "section3_2": { ... },
  "section4": { ... },
  "section5": { ... },
  "section5_1": { ... },
  "section6": { ... }
}
Each section should follow the official GSTR-3B structure and show aggregated totals.

Code Expectations:

Add a new controller → gstrController.js

Add a route file (or extend existing) → wire the /api/report/gstr3b POST endpoint

Use the MongoDB official Node.js driver (no extra ODMs like Mongoose)

Use async/await and proper error handling

Place reusable MongoDB queries into the mongoService.js or add helpers if needed

Ensure the API returns:

200 OK → with report JSON

Proper 400 or 500 status on errors

Log and handle MongoDB errors gracefully

Updated File Structure:
After your update, the backend should include:

backend/
  controllers/
    gstrController.js
  routes/
    gstrRoutes.js  (or extend existing routes)
Deliverables:

GSTR-3B sections
Calculate Section-wise GSTR-3B fields:

Header Section:

Legal name, trade name, GSTIN

Return period (year, month)

ARN and date (mock for now)

Authorized signatory details

Section 3.1 (Outward & Inward Supplies)

Group supply_transactions where type = OUTWARD by:

TAXABLE → regular taxable supplies

ZERO_RATED → zero-rated supplies

EXEMPT → nil-rated/exempted supplies

NON_GST → non-GST outward supplies

For type = INWARD and subType = RCM, aggregate under inward supplies liable to reverse charge

For each group, provide:

Total taxable value

Tax amounts (Integrated, Central, State, Cess)

Section 3.1.1 (Section 9(5) Supplies)

Track transactions via e-commerce operator (if applicable; assume counterparty.state or flag marks it)

Section 3.2 (Inter-state Supplies)

Group inter-state supplies by:

Unregistered persons

Composition taxable persons

UIN holders

Section 4 (Eligible ITC)

Sum up itc_payments.itc.amount where eligible = true

Sum up ITC reversed (rules 38, 42, 43)

Calculate Net ITC: eligible ITC − reversed ITC

Track ITC reclaimed, ineligible ITC under section 16(4), PoS-restricted ITC

Section 5 (Exempt / Nil-rated / Non-GST Supplies)

Track supplies from composition scheme, exempt supplies, nil-rated, non-GST supplies

Separate inter-state and intra-state

Section 5.1 (Interest & Late Fees)

Report:

System-computed interest

Interest paid

Late fees (Integrated, Central, State, Cess)

Section 6 (Tax Payment Details)

Tax payable amounts

Adjustments from previous periods

Net tax payable

Tax paid (through ITC, in cash)

Interest and late fee paid in cash

Updated package.json (if new dependencies added)

Updated route setup in server.js

A controller with clean, well-commented code that pulls and aggregates the correct data

A clear, structured response matching GSTR-3B sections